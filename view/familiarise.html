<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <!--<base href="/">-->
    <base href=".">

    <link rel="shortcut icon" href="images/favicon.ico">
    <title>Carbon Reduction Helper - Familiarise</title>

    <!-- Common file includes -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-173546127-1"></script>
    <script src="lib/common.js"></script>
    <link rel="stylesheet" href="lib/common.css">
    <link rel="stylesheet" href="lib/2.67123b20.chunk.css">
    <link rel="stylesheet" href="lib/main.a391ff7c.chunk.css">

    <script src="../model.js"></script>
	<script src="view.js"></script>
    <script src="../controller.js"></script>

    <!-- Locals -->

    <script>
        /**
         * Update the drop down list of steps to either
         *
         *    Filter       Action
         *    selected
         *    -----------------------------
         *    All          No need to reload the page so just refresh in place
         *    StateId
         *    StateId in URL If necessary at it Display it as it might have come from the "More info ..." on the select page
         *
         *
         *    1) All entries
         *    2) Only filtered entries
         *    3) If there is a stepId call step passed as a parameter, then add
         */
        handle_stepChange = function () {
            entering("handle_stepChange")

            let stepSelectorDivId = document.getElementById('stepSelectorDiv');
            let selectorId = document.getElementById('stepSelector')

            //*** Set step from url
            if(selectorId.value !== step){  // THEN step is different than step dropdown
                    log("handle_stepChange", "Reloading page with step = " + selectorId.value)
                    window.location.href = 'familiarise.html?step=' + selectorId.value
                }

            refresh_all()
            exiting("handle_stepChange")
        }

        handle_stepStateChange = function(newStateId){
            let selectorId = document.getElementById('stepSelector')
            model_setStepStateId(selectorId.value, newStateId)
            refresh_stepList()
        }

        function handle_adoptButtonClick(){

            //*** Set the step in the url to the version selected
            step = document.getElementById('stepSelector').value  // For gotoMenu()

            //*** Mark the step as adopting and save
            model_setStepStateId(step, "adopting")

            //*** Goto the familiarise page
            gotoMenu("complete.html")
        }

        refresh_all = function(){
            entering("refresh_all")

        //*** Step list
            refresh_stepList()

            //*** Set the step state
            stepStateSelector = document.getElementById('stepStateSelector')
            log("refresh_all", "Changing state drop-down from "
                + "'" + stepStateSelector.value + "' to "
                + "'" + model_getStepStateId(step) + "'")

            stepStateSelector.value = model_getStepStateId(step);
            // Note - setting a select element value above does not trigger the onchange() event.
            // This isn't a problem as no action is required.
            // It has been confirmed that setting the value property, correctly registers the new status but doesn't
            // trigger the onchange() event

            //*** Show related info
            refresh_stepInfo()

            exiting("refresh_all")
        }

        refresh_stepList = function(){
            //*** Populate the step selector drop-down
            log("Initialising", "Populating the step drop-down")
            let selectorDivId = document.getElementById('stepSelectorDiv');
            selectorDivId.innerHTML =
                create_selectHtmlByStepStateId(
                    "familiarising",
                    'id="stepSelector" onchange="handle_stepChange()"',
                    0
                )

            //*** Select the required step
            log("Initialising", "Select required step")
            let selectorId = document.getElementById('stepSelector')
            if(step === "") {   // THEN no step in URL

                // @todo Initialising to step '10' needs reviewing and maybe updating to first step in list
//                selectorId.value = "10"  // Initialise to first entry

            }else {  // Use the passed step
                log("Initialising", "step in URL detected")

                selectorId.value = step   // Note - the onchange() will not fire, but that is ok
            }
        }

        handle_suggestChanges = function(){
            alert("The information is stored in a Google doc so you will need to login in to Google")
            window.open(model_getStepEditUrl(step));
        }

refresh_stepInfo = function(){
    entering("refresh_all")
	
    let selectorId = document.getElementById('stepSelector')
    let embedUrl = model_getStepEmbedUrl(selectorId.value)
    if(embedUrl === ""){
        document.getElementById('docFrame').src = "more_info_notAvailable.html"
    }else {
        document.getElementById('docFrame').src = embedUrl;
    }
    exiting("refresh_stepInfo")
}
    </script>
</head>

<body data-gr-c-s-loaded="true">

<noscript>You need to enable JavaScript to run this app.</noscript>

<div id="root">
    <div>
        <header class="standAloneMode">
            <nav class="navbar-expand-sm navbar-toggleable-sm ng-white  mb-3 navbar-light">
                <div class="container">
                    <a class="navbar-brand" href="../index.html">Carbon Reduction Helper (proof-of-concept)</a>
<br>
                    <button aria-label="Toggle navigation" type="button" class="mr-2 navbar-toggler">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="d-sm-inline-flex flex-sm-row-reverse collapse navbar-collapse">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link" id="dashboard-tab" data-toggle="tab" href="#" role="tab" aria-controls="home" aria-selected="true"
                                   onclick="gotoMenu('dashboard.html');return false">Dashboard</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="select-tab" data-toggle="tab" href="#" role="tab" aria-controls="home" aria-selected="true"
                                   onclick="gotoMenu('plan.html');return false">Select</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" id="familiarise-tab" data-toggle="tab" href="#" role="tab" aria-controls="home" aria-selected="true"
                                   onclick="gotoMenu('familiarise.html');return false">Familiarise</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="adopt-tab" data-toggle="tab" href="#" role="tab" aria-controls="home" aria-selected="true"
                                   onclick="gotoMenu('complete.html');return false">Adopt</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="help-tab" data-toggle="tab" href="#" role="tab" aria-controls="home" aria-selected="true"
                                   onclick="gotoMenu('help.html');return false">Help</a>
                            </li>
                        </ul>

                    </div>
                </div>
            </nav>
        </header>
        <div class="container-xl">
            <div class="row">
            	<div id="statusAndOptions">
				</div>
                <div id="mainWindow">
                    <!--suppress HtmlDeprecatedAttribute -->
                    <div align="center">
                        <div class="tips standAloneMode"></div> <!-- Tips -->
                        Familiarise with <div id="stepSelectorDiv"></div>
                    </div>
                    <br>
                    <br>
                    <div align="right">
                        [<a
                            href="#"
                            onClick="handle_suggestChanges(); return false"
                        >Suggest updates ...</a>]
                    </div>

                    <iframe
                            id="docFrame"
                            src="more_info_blank.html"
                            width="100%" height="1000">
                    </iframe><br>

                    <!-- @todo - to be evaluated.
                    <div>
                        Note:<br>
                           If you don't have off-road parking there are several options to install on-street charge points.<br>
                        Automatically submit your request for on-street charging in the Adopt page.
                    </div>
                    -->
                </div>
                <br>
                <div id="discussion1">
                    <div id="disqus_thread"></div>
                </div>
                <div id="contextMenu">
                    <div class="sticky-top pt-2 standAloneMode">
                        <div class="card">
                            <div class="card-header">
                                <h4>Menu</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <table>
                                        <tr>
                                            <td>
                                                <input
                                                        id="AdoptButtonId"
                                                        type="button"
                                                        value="Adopt"
                                                        class = "quickMenuButton"
                                                        onclick="handle_adoptButtonClick()"
                                                >
                                                Change status to:
                                                <select id="stepStateSelector"
                                                        onChange="handle_stepStateChange(this.value)">
                                                    <option value=""></option>
                                                    <option value="monitoring">Monitoring</option>
                                                    <option value="familiarising">Familiarising</option>
                                                    <option value="adopting">Adopting</option>
                                                    <option value="completed">Completed</option>
                                                    <option value="na">Not applicable</option>
                                                    <option value="rejected">Rejected</option>
                                                </select><br>
                                                Follow changes <input type="checkbox"><br>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- card -->

                    </div> <!-- sticky-top pt-2 -->
                </div> <!-- contextMenu -->
            </div> <!-- row -->
        </div> <!-- container-xl -->
    </div>
</div>

<script>
    entering("Initialising")

    controller_init()
    refresh_all()

    exiting("Initialising")
</script>

</body>
</html>